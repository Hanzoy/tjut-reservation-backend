<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.hanzoy.tjutreservation.mapper.MeetingMapper">
    <insert id="insertMeeting" useGeneratedKeys="true" keyColumn="id" keyProperty="id">
        insert into
            tjut_reservation.meeting(name, creator, room_id, date, start_time, end_time, content)
            VALUES(#{name}, #{creator}, #{roomId}, #{date}, #{startTime}, #{endTime}, #{content})
    </insert>

    <select id="selectMeetingByDate" resultType="com.hanzoy.tjutreservation.pojo.po.MeetingPo">
        select
               id, name, creator, room_id AS roomId, date, start_time AS startTime, end_time AS endTime, content
        from
             tjut_reservation.meeting
        where
              date = #{date};
    </select>

    <select id="selectRoomById" resultType="com.hanzoy.tjutreservation.pojo.po.MeetingRoomPo">
        select
               id, name, date, time, remark
        from
             tjut_reservation.meeting_room
        where
              id = #{id};
    </select>

    <insert id="insertParticipant" useGeneratedKeys="true" keyColumn="id">
        insert into tjut_reservation.participant(user, meeting) VALUES (#{openid}, #{meeting})
    </insert>

    <select id="selectCountForYearByMonth" resultType="int">
        select
               COUNT(m.id)
        from
             tjut_reservation.meeting m
        left join
                tjut_reservation.participant p
        on
            p.meeting = m.id
        where
              date like CONCAT(#{year}, '-%', #{month}, '-%')
        and
            p.user = #{openid};
    </select>

    <select id="selectMeetingByYearAndMonth" resultType="com.hanzoy.tjutreservation.pojo.po.MeetingPo">
        select
            m.id, m.name, u.name AS creator, r.name AS roomId, m.date, m.start_time AS startTime, end_time AS endTime
        from
            tjut_reservation.meeting m
                left join
                    tjut_reservation.users u
                on
                    m.creator = u.openid
                left join
                    tjut_reservation.meeting_room r
                on
                    m.room_id = r.id
                left join
                    tjut_reservation.participant p
                on
                    p.meeting = m.id
        where
            m.date like CONCAT(#{year}, '-%', #{month}, '-%')
        and
            p.user = #{openid}
        order by date DESC, startTime DESC;
    </select>

    <select id="selectMeetingById" resultType="com.hanzoy.tjutreservation.pojo.dto.result.GetReservationResult">
        select
            m.id, m.name, u.name as creator, mr.name AS meetingName, m.date, CONCAT(start_time , '-', end_time) AS time, content
        from
             tjut_reservation.meeting m
                 left join
                 tjut_reservation.users u
                     on u.openid = m.creator left join tjut_reservation.meeting_room mr on mr.id = m.room_id
        where
              m.id = #{id};
    </select>

    <select id="selectIsCreator" resultType="integer">
        select
               id
        from
             tjut_reservation.meeting
        where
              id = #{id}
          and
              creator = #{openid};
    </select>

    <select id="selectParticipantList" resultType="com.hanzoy.tjutreservation.pojo.dto.result.GetReservationResult$User">
        select
               u.openid AS id, u.name, u.nick_name AS nickName, u.avatar_url AS avatarUrl
        from
             tjut_reservation.participant p
                 left join
                 tjut_reservation.users u
                     on u.openid = p.user
        where
              p.meeting = #{id};
    </select>
</mapper>
